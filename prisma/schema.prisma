generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id                   String                @id @default(uuid())
  email                String?               @unique
  name                 String
  provider             Provider              @default(LOCAL)
  providerId           String?
  password             String?
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  isEmailVerified      Boolean               @default(false)
  isAdmin              Boolean               @default(false)
  lastLoginAt          DateTime?
  phoneNumber          String?               @db.VarChar(20)
  profileImageKey      String?               @db.VarChar(255)
  announcementReads    AnnouncementRead[]    @relation("AnnouncementReads")
  announcements        Announcement[]        @relation("AnnouncementAuthor")
  answers              Answer[]              @relation("AdminAnswers")
  categories           Category[]
  deviceTokens         DeviceToken[]
  groupMemberships     GroupMember[]
  notificationSettings NotificationSetting[]
  notifications        Notification[]
  questions            Question[]
  recurrings           Recurring[]
  taskHistories        TaskHistory[]
  taskReminders        TaskReminder[]
  taskSkips            TaskSkip[]
  tasks                Task[]

  @@unique([provider, providerId])
  @@index([email])
  @@map("users")
}

model Group {
  id                  String             @id @default(uuid())
  name                String             @db.VarChar(100)
  description         String?            @db.Text
  inviteCode          String             @unique @db.VarChar(8)
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt
  defaultColor        String             @default("#6366F1") @db.VarChar(7)
  inviteCodeExpiresAt DateTime
  categories          Category[]
  joinRequests        GroupJoinRequest[]
  members             GroupMember[]
  recurrings          Recurring[]
  customRoles         Role[]
  tasks               Task[]

  @@index([inviteCode])
  @@map("member_groups")
}

model Role {
  id            String        @id @default(uuid())
  name          String        @db.VarChar(50)
  groupId       String?
  isDefaultRole Boolean       @default(false)
  permissions   Json
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  isImmutable   Boolean       @default(false)
  sortOrder     Int           @default(0)
  color         String        @default("#6366F1") @db.VarChar(7)
  groupMembers  GroupMember[]
  group         Group?        @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@unique([name, groupId])
  @@index([groupId])
  @@index([sortOrder])
  @@map("roles")
}

model GroupMember {
  id          String   @id @default(uuid())
  groupId     String
  userId      String
  joinedAt    DateTime @default(now())
  customColor String?  @db.VarChar(7)
  roleId      String
  group       Group    @relation(fields: [groupId], references: [id], onDelete: Cascade)
  role        Role     @relation(fields: [roleId], references: [id])
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([groupId, userId])
  @@index([groupId])
  @@index([userId])
  @@index([roleId])
  @@map("group_members")
}

model GroupJoinRequest {
  id        String            @id @default(uuid())
  groupId   String
  type      JoinRequestType   @default(REQUEST)
  email     String            @db.VarChar(255)
  status    JoinRequestStatus @default(PENDING)
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt
  group     Group             @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@index([groupId])
  @@index([email])
  @@index([status])
  @@map("group_join_requests")
}

model Permission {
  id          String             @id @default(uuid())
  code        PermissionCode     @unique
  name        String             @db.VarChar(100)
  description String?            @db.Text
  category    PermissionCategory @default(GROUP)
  isActive    Boolean            @default(true)
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  sortOrder   Int                @default(0)

  @@index([category])
  @@index([isActive])
  @@index([sortOrder])
  @@map("permissions")
}

model DeviceToken {
  id        String         @id @default(uuid())
  userId    String
  token     String         @unique @db.VarChar(500)
  platform  DevicePlatform
  lastUsed  DateTime       @default(now())
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt
  user      User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([lastUsed])
  @@map("device_tokens")
}

model NotificationSetting {
  id        String                         @id @default(uuid())
  userId    String
  category  notification_settings_category
  enabled   Boolean                        @default(true)
  createdAt DateTime                       @default(now())
  updatedAt DateTime                       @updatedAt
  user      User                           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, category])
  @@index([userId])
  @@map("notification_settings")
}

model Notification {
  id        String                 @id @default(uuid())
  userId    String
  category  notifications_category
  title     String                 @db.VarChar(255)
  body      String                 @db.Text
  data      Json?
  sent      Boolean                @default(false) // FCM 발송 성공 여부
  isRead    Boolean                @default(false)
  createdAt DateTime               @default(now()) // 생성 시간 (히스토리 저장 시점)
  sentAt    DateTime?              // FCM 발송 성공 시간
  readAt    DateTime?
  user      User                   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
  @@index([sent])
  @@index([createdAt])
  @@map("notifications")
}

model Announcement {
  id          String               @id @default(uuid())
  authorId    String
  title       String               @db.VarChar(200)
  content     String               @db.Text
  isPinned    Boolean              @default(false)
  attachments Json?
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt
  deletedAt   DateTime?
  category    AnnouncementCategory
  viewCount   Int                  @default(0)
  reads       AnnouncementRead[]
  author      User                 @relation("AnnouncementAuthor", fields: [authorId], references: [id])

  @@index([isPinned, createdAt(sort: Desc)])
  @@index([category])
  @@index([createdAt(sort: Desc)])
  @@index([authorId])
  @@map("announcements")
}

model AnnouncementRead {
  id             String       @id @default(uuid())
  announcementId String
  userId         String
  readAt         DateTime     @default(now())
  announcement   Announcement @relation(fields: [announcementId], references: [id], onDelete: Cascade)
  user           User         @relation("AnnouncementReads", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([announcementId, userId])
  @@index([announcementId])
  @@index([userId])
  @@map("announcement_reads")
}

model Question {
  id          String             @id @default(uuid())
  userId      String
  title       String             @db.VarChar(200)
  content     String             @db.Text
  category    QuestionCategory
  status      QuestionStatus     @default(PENDING)
  visibility  QuestionVisibility @default(PRIVATE)
  attachments Json?
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  deletedAt   DateTime?
  answers     Answer[]
  user        User               @relation(fields: [userId], references: [id])

  @@index([userId, createdAt(sort: Desc)])
  @@index([status])
  @@index([category])
  @@index([visibility, createdAt(sort: Desc)])
  @@map("questions")
}

model Answer {
  id          String    @id @default(uuid())
  questionId  String
  adminId     String
  content     String    @db.Text
  attachments Json?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?
  admin       User      @relation("AdminAnswers", fields: [adminId], references: [id])
  question    Question  @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@index([questionId, createdAt(sort: Desc)])
  @@index([adminId], map: "answers_adminId_fkey")
  @@map("answers")
}

model Category {
  id          String   @id @default(uuid())
  userId      String
  groupId     String?
  name        String   @db.VarChar(50)
  description String?  @db.Text
  emoji       String?  @db.VarChar(10)
  color       String?  @db.VarChar(7)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  group       Group?   @relation(fields: [groupId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  tasks       Task[]

  @@index([userId])
  @@index([groupId])
  @@index([userId, groupId])
  @@map("categories")
}

model Task {
  id          String         @id @default(uuid())
  userId      String
  groupId     String?
  categoryId  String
  recurringId String?
  title       String         @db.VarChar(200)
  description String?        @db.Text
  location    String?        @db.VarChar(255)
  type        TaskType       @default(TODO_LINKED)
  priority    TaskPriority   @default(MEDIUM)
  scheduledAt DateTime?
  dueAt       DateTime?
  isCompleted Boolean        @default(false)
  completedAt DateTime?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  deletedAt   DateTime?
  histories   TaskHistory[]
  reminders   TaskReminder[]
  category    Category       @relation(fields: [categoryId], references: [id])
  group       Group?         @relation(fields: [groupId], references: [id], onDelete: Cascade)
  recurring   Recurring?     @relation(fields: [recurringId], references: [id])
  user        User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, scheduledAt])
  @@index([groupId, scheduledAt])
  @@index([categoryId])
  @@index([recurringId])
  @@index([isCompleted])
  @@index([deletedAt])
  @@map("tasks")
}

model Recurring {
  id              String                  @id @default(uuid())
  userId          String
  groupId         String?
  ruleType        RecurringRuleType
  ruleConfig      Json
  generationType  RecurringGenerationType
  lastGeneratedAt DateTime?
  isActive        Boolean                 @default(true)
  createdAt       DateTime                @default(now())
  updatedAt       DateTime                @updatedAt
  group           Group?                  @relation(fields: [groupId], references: [id], onDelete: Cascade)
  user            User                    @relation(fields: [userId], references: [id], onDelete: Cascade)
  skips           TaskSkip[]
  tasks           Task[]

  @@index([userId])
  @@index([groupId])
  @@index([isActive])
  @@map("recurrings")
}

model TaskReminder {
  id            String           @id @default(uuid())
  taskId        String
  userId        String
  reminderType  TaskReminderType
  offsetMinutes Int
  sentAt        DateTime?
  createdAt     DateTime         @default(now())
  task          Task             @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user          User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([taskId])
  @@index([userId])
  @@index([sentAt])
  @@map("task_reminders")
}

model TaskSkip {
  id          String    @id @default(uuid())
  recurringId String
  skipDate    DateTime  @db.Date
  reason      String?   @db.Text
  createdBy   String
  createdAt   DateTime  @default(now())
  creator     User      @relation(fields: [createdBy], references: [id])
  recurring   Recurring @relation(fields: [recurringId], references: [id], onDelete: Cascade)

  @@index([recurringId])
  @@index([skipDate])
  @@index([createdBy], map: "task_skips_createdBy_fkey")
  @@map("task_skips")
}

model TaskHistory {
  id        String            @id @default(uuid())
  taskId    String
  userId    String
  action    TaskHistoryAction
  changes   Json?
  createdAt DateTime          @default(now())
  task      Task              @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user      User              @relation(fields: [userId], references: [id])

  @@index([taskId, createdAt(sort: Desc)])
  @@index([userId])
  @@map("task_histories")
}

enum Provider {
  GOOGLE
  KAKAO
  APPLE
  LOCAL
}

enum PermissionCategory {
  GROUP
  TASK
}

enum PermissionCode {
  INVITE_MEMBER
  DELETE_GROUP
  UPDATE_GROUP
  MANAGE_ROLE
  MANAGE_MEMBER
  READ_TASK
  CREATE_TASK
  UPDATE_TASK
  DELETE_TASK
  MANAGE_CATEGORY
}

enum JoinRequestType {
  REQUEST
  INVITE
}

enum JoinRequestStatus {
  PENDING
  ACCEPTED
  REJECTED
}

enum DevicePlatform {
  IOS
  ANDROID
  WEB
}

enum QuestionCategory {
  BUG
  FEATURE
  USAGE
  ACCOUNT
  PAYMENT
  ETC
}

enum QuestionStatus {
  PENDING
  ANSWERED
  RESOLVED
}

enum QuestionVisibility {
  PUBLIC
  PRIVATE
}

enum AnnouncementCategory {
  ANNOUNCEMENT
  EVENT
  UPDATE
}

enum TaskType {
  CALENDAR_ONLY
  TODO_LINKED
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum RecurringRuleType {
  DAILY
  WEEKLY
  MONTHLY
  YEARLY
}

enum RecurringGenerationType {
  AUTO_SCHEDULER
  AFTER_COMPLETION
}

enum TaskReminderType {
  BEFORE_START
  BEFORE_DUE
}

enum TaskHistoryAction {
  CREATE
  UPDATE
  DELETE
  COMPLETE
  SKIP
}

enum notification_settings_category {
  SCHEDULE
  TODO
  HOUSEHOLD
  ASSET
  CHILDCARE
  GROUP
  SYSTEM
}

enum notifications_category {
  SCHEDULE
  TODO
  HOUSEHOLD
  ASSET
  CHILDCARE
  GROUP
  SYSTEM
}
