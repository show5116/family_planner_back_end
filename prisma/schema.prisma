// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// 소셜 로그인 제공자
enum Provider {
  GOOGLE
  KAKAO
  APPLE
  LOCAL
}

// 권한 카테고리
enum PermissionCategory {
  GROUP   // 그룹
}

// 권한 코드
enum PermissionCode {
  // GROUP 카테고리
  INVITE_MEMBER
  DELETE_GROUP
  UPDATE_GROUP
  MANAGE_ROLE
  MANAGE_MEMBER
}

// 그룹 가입 요청 타입
enum JoinRequestType {
  REQUEST // 사용자가 초대 코드로 가입 요청
  INVITE  // 관리자가 이메일로 초대
}

// 그룹 가입 요청 상태
enum JoinRequestStatus {
  PENDING  // 대기 중
  ACCEPTED // 승인됨
  REJECTED // 거부됨
}

// 알림 카테고리
enum NotificationCategory {
  SCHEDULE  // 일정
  TODO      // 할일
  HOUSEHOLD // 가계부
  ASSET     // 자산
  CHILDCARE // 육아
  GROUP     // 그룹 (초대, 멤버 추가 등)
  SYSTEM    // 시스템 알림
}

// 디바이스 플랫폼
enum DevicePlatform {
  IOS
  ANDROID
  WEB
}

// Q&A 질문 카테고리
enum QuestionCategory {
  BUG      // 버그 신고
  FEATURE  // 기능 제안/개선
  USAGE    // 사용법 문의
  ACCOUNT  // 계정 문제
  PAYMENT  // 결제/요금제
  ETC      // 기타
}

// Q&A 질문 상태
enum QuestionStatus {
  PENDING  // 대기 중 (답변 대기)
  ANSWERED // 답변 완료 (ADMIN 답변 완료)
  RESOLVED // 해결 완료 (사용자가 해결 확인)
}

// Q&A 공개 여부
enum QuestionVisibility {
  PUBLIC  // 공개 (모든 사용자가 조회 가능)
  PRIVATE // 비공개 (작성자와 ADMIN만 조회 가능)
}

// 사용자 테이블
model User {
  id                        String         @id @default(uuid())
  email                     String?        @unique
  name                      String
  profileImageKey           String?        @db.VarChar(255) // R2에 저장된 프로필 이미지 키
  phoneNumber               String?        @db.VarChar(20) // 전화번호
  provider                  Provider       @default(LOCAL)
  providerId                String?        // 소셜 로그인 제공자의 고유 ID
  password                  String?        // LOCAL 로그인 시에만 사용, 소셜 로그인 시 null
  isEmailVerified           Boolean        @default(false) // 이메일 인증 여부
  isAdmin                   Boolean        @default(false) // 관리자 여부
  emailVerificationToken    String?        @db.VarChar(255) // 이메일 인증 토큰
  emailVerificationExpires  DateTime?      // 이메일 인증 토큰 만료 시간
  passwordResetToken        String?        @db.VarChar(255) // 비밀번호 재설정 토큰
  passwordResetExpires      DateTime?      // 비밀번호 재설정 토큰 만료 시간
  lastLoginAt               DateTime?      // 마지막 로그인 시간
  createdAt                 DateTime               @default(now())
  updatedAt                 DateTime               @updatedAt
  refreshTokens             RefreshToken[]         // RTR 방식을 위한 다중 refresh token 지원
  groupMemberships          GroupMember[]          // 사용자가 속한 그룹들
  deviceTokens              DeviceToken[]          // FCM 디바이스 토큰들
  notificationSettings      NotificationSetting[]  // 알림 설정
  notifications             Notification[]         // 받은 알림들
  announcements             Announcement[]         @relation("AnnouncementAuthor") // 작성한 공지사항들
  announcementReads         AnnouncementRead[]     @relation("AnnouncementReads") // 읽은 공지사항들
  questions                 Question[]             // 작성한 질문들
  answers                   Answer[]               @relation("AdminAnswers") // 작성한 답변들 (ADMIN 전용)

  @@unique([provider, providerId]) // 같은 제공자에서 같은 ID는 유일해야 함
  @@index([email])
  @@index([emailVerificationToken])
  @@index([passwordResetToken])
  @@map("users")
}

// Refresh Token 테이블 (RTR 방식)
model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique @db.VarChar(500)
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())
  isRevoked Boolean  @default(false) // 토큰 무효화 여부

  @@index([userId])
  @@map("refresh_tokens")
}

// 그룹 테이블
model Group {
  id                  String             @id @default(uuid())
  name                String             @db.VarChar(100) // 그룹명
  description         String?            @db.Text // 그룹 설명
  inviteCode          String             @unique @db.VarChar(8) // 초대 코드 (8자리 영문+숫자)
  inviteCodeExpiresAt DateTime           // 초대 코드 만료 시간
  defaultColor        String             @default("#6366F1") @db.VarChar(7) // 그룹 기본 색상 (HEX)
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt
  members             GroupMember[]      // 그룹 멤버들
  customRoles         Role[]             // 그룹별 커스텀 역할들
  joinRequests        GroupJoinRequest[] // 그룹 가입 요청들

  @@index([inviteCode])
  @@map("member_groups")
}

// 역할 테이블 (공통 역할 + 그룹별 커스텀 역할)
model Role {
  id              String        @id @default(uuid())
  name            String        @db.VarChar(50) // 역할명 (예: OWNER, ADMIN, MEMBER, 부모, 자녀 등)
  groupId         String?       // null이면 공통 역할, 값이 있으면 그룹별 커스텀 역할
  group           Group?        @relation(fields: [groupId], references: [id], onDelete: Cascade)
  isDefaultRole   Boolean       @default(false) // 초대 시 자동 부여 역할 여부
  isImmutable     Boolean       @default(false) // true이면 수정 불가능한 역할 (예: OWNER, ADMIN, MEMBER)
  permissions     Json          @default("[]") // 권한 목록 (JSON 배열: ["VIEW", "CREATE", "UPDATE", ...])
  color           String        @default("#6366F1") @db.VarChar(7) // 역할 색상 (HEX)
  sortOrder       Int           @default(0) // 정렬 순서 (낮을수록 먼저 표시)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  groupMembers    GroupMember[] // 이 역할을 가진 멤버들

  @@unique([name, groupId]) // 같은 그룹(또는 공통)에서 역할명 중복 방지
  @@index([groupId])
  @@index([sortOrder])
  @@map("roles")
}

// 그룹 멤버 테이블
model GroupMember {
  id          String   @id @default(uuid())
  groupId     String
  group       Group    @relation(fields: [groupId], references: [id], onDelete: Cascade)
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  roleId      String   // Role 테이블 참조
  role        Role     @relation(fields: [roleId], references: [id])
  customColor String?  @db.VarChar(7) // 개인 설정 색상 (HEX, nullable)
  joinedAt    DateTime @default(now())

  @@unique([groupId, userId]) // 같은 그룹에 같은 사용자 중복 방지
  @@index([groupId])
  @@index([userId])
  @@index([roleId])
  @@map("group_members")
}

// 그룹 가입 요청 테이블
model GroupJoinRequest {
  id        String            @id @default(uuid())
  groupId   String
  group     Group             @relation(fields: [groupId], references: [id], onDelete: Cascade)
  type      JoinRequestType   @default(REQUEST) // REQUEST: 사용자 요청, INVITE: 관리자 초대
  email     String            @db.VarChar(255) // 초대 대상 이메일
  status    JoinRequestStatus @default(PENDING) // PENDING, ACCEPTED, REJECTED
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt

  @@index([groupId])
  @@index([email])
  @@index([status])
  @@map("group_join_requests")
}

// 권한 정의 테이블 (UI 표시 및 메타데이터용)
model Permission {
  id          String             @id @default(uuid())
  code        PermissionCode     @unique // 권한 코드
  name        String             @db.VarChar(100) // 권한 이름 (예: "조회", "생성", "수정", "삭제")
  description String?            @db.Text // 권한 설명
  category    PermissionCategory @default(GROUP) // 권한 카테고리
  isActive    Boolean            @default(true) // 활성화 여부
  sortOrder   Int                @default(0) // 정렬 순서 (낮을수록 먼저 표시)
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt

  @@index([category])
  @@index([isActive])
  @@index([sortOrder])
  @@map("permissions")
}

// FCM 디바이스 토큰 테이블
model DeviceToken {
  id        String         @id @default(uuid())
  userId    String
  user      User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  token     String         @unique @db.VarChar(500) // FCM 디바이스 토큰
  platform  DevicePlatform // IOS, ANDROID, WEB
  lastUsed  DateTime       @default(now()) // 마지막 사용 시간
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt

  @@index([userId])
  @@index([lastUsed])
  @@map("device_tokens")
}

// 알림 설정 테이블 (카테고리별 알림 on/off)
model NotificationSetting {
  id        String               @id @default(uuid())
  userId    String
  user      User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  category  NotificationCategory // 알림 카테고리
  enabled   Boolean              @default(true) // 알림 활성화 여부
  createdAt DateTime             @default(now())
  updatedAt DateTime             @updatedAt

  @@unique([userId, category]) // 사용자당 카테고리별 하나의 설정만 존재
  @@index([userId])
  @@map("notification_settings")
}

// 알림 히스토리 테이블
model Notification {
  id        String               @id @default(uuid())
  userId    String
  user      User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  category  NotificationCategory // 알림 카테고리
  title     String               @db.VarChar(255) // 알림 제목
  body      String               @db.Text // 알림 내용
  data      Json?                // 추가 데이터 (화면 이동용 payload 등)
  isRead    Boolean              @default(false) // 읽음 여부
  sentAt    DateTime             @default(now()) // 발송 시간
  readAt    DateTime?            // 읽은 시간

  @@index([userId])
  @@index([isRead])
  @@index([sentAt])
  @@map("notifications")
}

// 공지사항 테이블
model Announcement {
  id          String             @id @default(uuid())
  authorId    String // ADMIN 사용자 ID
  author      User               @relation("AnnouncementAuthor", fields: [authorId], references: [id])
  title       String             @db.VarChar(200) // 공지 제목
  content     String             @db.Text // 공지 내용 (Markdown 지원)
  isPinned    Boolean            @default(false) // 상단 고정 여부
  attachments Json? // 첨부파일 목록 [{url, name, size}]
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  deletedAt   DateTime? // Soft Delete
  reads       AnnouncementRead[] // 읽음 기록

  @@index([isPinned, createdAt(sort: Desc)]) // 고정 공지 우선 정렬
  @@index([createdAt(sort: Desc)]) // 최신순 조회
  @@index([authorId])
  @@map("announcements")
}

// 공지사항 읽음 기록 테이블
model AnnouncementRead {
  id             String       @id @default(uuid())
  announcementId String
  announcement   Announcement @relation(fields: [announcementId], references: [id], onDelete: Cascade)
  userId         String
  user           User         @relation("AnnouncementReads", fields: [userId], references: [id], onDelete: Cascade)
  readAt         DateTime     @default(now()) // 읽은 시간

  @@unique([announcementId, userId]) // 공지별 사용자당 하나의 읽음 기록만
  @@index([announcementId])
  @@index([userId])
  @@map("announcement_reads")
}

// Q&A 질문 테이블
model Question {
  id          String               @id @default(uuid())
  userId      String
  user        User                 @relation(fields: [userId], references: [id])
  title       String               @db.VarChar(200) // 질문 제목
  content     String               @db.Text // 질문 내용
  category    QuestionCategory // 카테고리 (BUG, FEATURE, USAGE 등)
  status      QuestionStatus       @default(PENDING) // 상태 (PENDING, ANSWERED, RESOLVED)
  visibility  QuestionVisibility   @default(PRIVATE) // 공개 여부 (PUBLIC, PRIVATE)
  attachments Json? // 첨부파일 [{url, name, size}]
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt
  deletedAt   DateTime? // Soft Delete
  answers     Answer[] // 답변 목록

  @@index([userId, createdAt(sort: Desc)]) // 사용자별 질문 조회
  @@index([status]) // 상태별 필터링
  @@index([category]) // 카테고리별 필터링
  @@index([visibility, createdAt(sort: Desc)]) // 공개 질문 목록 조회
  @@map("questions")
}

// Q&A 답변 테이블
model Answer {
  id          String    @id @default(uuid())
  questionId  String
  question    Question  @relation(fields: [questionId], references: [id], onDelete: Cascade)
  adminId     String
  admin       User      @relation("AdminAnswers", fields: [adminId], references: [id])
  content     String    @db.Text // 답변 내용
  attachments Json? // 첨부파일 [{url, name, size}]
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime? // Soft Delete

  @@index([questionId, createdAt(sort: Desc)]) // 질문별 답변 조회
  @@map("answers")
}
